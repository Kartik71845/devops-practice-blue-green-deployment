name: Blue-Green Deployment

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy application
        run: |
          ssh ubuntu@${{ secrets.EC2_HOST }} << 'EOF'

          ACTIVE_COLOR=$(cat /var/app/active_color)

          if [ "$ACTIVE_COLOR" = "blue" ]; then
            NEW_COLOR="green"
            NEW_PORT=8082
            OLD_CONTAINER="app-blue"
            NEW_CONTAINER="app-green"
            NGINX_CONF="green.conf"
          else
            NEW_COLOR="blue"
            NEW_PORT=8081
            OLD_CONTAINER="app-green"
            NEW_CONTAINER="app-blue"
            NGINX_CONF="blue.conf"
          fi

          echo "Deploying $NEW_COLOR version"

          docker rm -f $NEW_CONTAINER || true

          docker build -t my-app ~/app

          docker run -d \
            --name $NEW_CONTAINER \
            -p $NEW_PORT:8080 \
            -e APP_COLOR=$NEW_COLOR \
            my-app

          sudo cp ~/nginx/$NGINX_CONF /etc/nginx/sites-enabled/default
          sudo nginx -s reload

          docker rm -f $OLD_CONTAINER || true

          echo "$NEW_COLOR" | sudo tee /var/app/active_color

          EOF
